{
    "AWSTemplateFormatVersion" : "2010-09-09",

    "Description" : "AWS CloudFormation Template: Single-node Tableau Server running on Windows, CentOS, or Ubuntu.",

    "Parameters" : {
        "InstanceType" : {
            "Description" : "Amazon EC2 instance type",
            "Type" : "String",
            "Default" : "m4.4xlarge",
            "AllowedValues" : [ "m4.2xlarge", "m4.4xlarge", "m4.10xlarge"],
            "ConstraintDescription" : "must be a valid EC2 instance type."
        },
        "TableauServerVolumeSize" : {
            "Description" : "Size of volume for server in GB; need at least 30 GB free for server installation",
            "Type" : "Number",
            "MinValue" : "30",
            "MaxValue" : "16384",
            "Default" : "100"
        },
        "KeyPairName": {
            "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instances",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
        },
        "SourceCIDR": {
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$",
            "ConstraintDescription": "CIDR block parameter must be in the form x.x.x.x/x",
            "Description": "The CIDR address from which you will connect to the instance",
            "Type": "String"
        },
        "Username" : {
            "Description" : "(Linux only) Tableau Services Manager (TSM) administrator username (cannot be 'tableau' or 'tsmagent' or 'admin')",
            "Type": "String"
        },
        "Password" : {
            "Description" : "(Linux only) Tableau Services Manager (TSM) administrator password",
            "Type": "String",
            "NoEcho" : "true"
        },
        "TableauServerAdminUser" : {
            "Description" : "The name of the initial administrator for Tableau Server",
            "Type" : "String",
            "MinLength" : "1"
        },
        "TableauServerAdminPassword" : {
            "Description" : "The password of the initial administrator for Tableau Server",
            "Type" : "String",
            "MinLength" : "1",
            "NoEcho" : "true"
        },
        "TableauServerLicenseKey" : {
            "Description" : "License Key (leave blank for trial)",
            "Type" : "String"
        },
        "RegFirstName" : {
            "Description" : "First Name",
            "Type" : "String",
            "MinLength" : "1"
        },
        "RegLastName" : {
            "Description" : "Last Name",
            "Type" : "String",
            "MinLength" : "1"
        },
        "RegEmail" : {
            "Description" : "Email",
            "Type" : "String",
            "MinLength" : "1"
        },
        "RegCompany" : {
            "Description" : "Company",
            "Type" : "String"
        },
        "RegTitle" : {
            "Description" : "Title",
            "Type" : "String"
        },
        "RegDepartment" : {
            "Description" : "Department",
            "Type" : "String"
        },
        "RegIndustry" : {
            "Description" : "Industry",
            "Type" : "String"
        },
        "RegPhone" : {
            "Description" : "Phone",
            "Type" : "String"
        },
        "RegCity" : {
            "Description" : "City",
            "Type" : "String"
        },
        "RegState" : {
            "Description" : "State",
            "Type" : "String"
        },
        "RegZip" : {
            "Description" : "ZIP/Postal Code",
            "Type" : "String"
        },
        "RegCountry" : {
            "Description" : "Country",
            "Type" : "String"
        },
        "ExistingSecurityGroup" : {
            "Description" : "Provide an existing security group or leave blank for creating a new one",
            "Type" : "String"
        },
        "IPAddress" : {
            "Description" : "Provide an EIP for the node (blank = no EIP)",
            "Type" : "String"
        },
        "AMIOS": {
            "AllowedValues": [
                "Windows",
                "CentOS-7-HVM",
                "Ubuntu-Server-16.04-LTS-HVM"
            ],
            "Default": "CentOS-7-HVM",
            "Description": "Operation System on which Tableau Server will be deployed",
            "Type": "String"
        }
    },

    "Metadata" : {
        "AWS::CloudFormation::Interface" : {
            "ParameterGroups" : [
                {
                    "Label" : { "default":"AWS Environment and Machine Configuration" },
                    "Parameters" : [ "InstanceType", "TableauServerVolumeSize", "KeyPairName", "AMIOS", "SourceCIDR", "ExistingSecurityGroup", "IPAddress" ]
                },
                {
                    "Label" : { "default" : "Secrets" },
                    "Parameters" : [ "Username", "Password", "TableauServerAdminUser", "TableauServerAdminPassword" ]
                },
                {
                    "Label" : { "default" : "Registration" },
                    "Parameters" : ["TableauServerLicenseKey",
                                    "RegFirstName","RegLastName","RegEmail",
                                    "RegCompany","RegTitle","RegDepartment","RegIndustry",
                                    "RegPhone","RegCity","RegState","RegZip","RegCountry"]
                }
            ],

            "ParameterLabels" : {
                "InstanceType" : { "default" : "Tableau Amazon EC2 instance type" },
                "TableauServerVolumeSize" : { "default" : "Size for server volume in GB" },
                "KeyPairName" : { "default" : "Key Pair Name" },
                "SourceCIDR" : { "default" : "Source CIDR for Access" },
                "ExistingSecurityGroup": { "default": "Existing Security Group" },
                "IPAddress": { "default": "EIP address for the node" },
                "Username" : { "default" : "Tableau Services Manager (TSM) administrator username" },
                "Password" : { "default" : "Tableau Services Manager (TSM) administrator password" },
                "TableauServerAdminUser": { "default": "Tableau Server administrator username" },
                "TableauServerAdminPassword": { "default": "Tableau Server administrator password" },
                "TableauServerLicenseKey": { "default": "Tableau Activation Key" },
                "RegFirstName": { "default": "First Name" },
                "RegLastName": { "default": "Last name" },
                "RegEmail": { "default": "Email Address" },
                "RegCompany": { "default": "Company" },
                "RegTitle": { "default": "Title" },
                "RegDepartment": { "default": "Department" },
                "RegIndustry": { "default": "Industry" },
                "RegPhone": { "default": "Phone" },
                "RegCity": { "default": "City" },
                "RegState": { "default": "State" },
                "RegZip": { "default": "Zip/Postal Code" },
                "RegCountry": { "default": "Country" }
            }
        }
    },

    "Mappings" : {
        "DefaultConfiguration": {
            "QSS3Config": {
                "QSS3BucketName": "quickstart-reference",
                "QSS3KeyPrefix": "tableau",
                "QuickStartS3URL": "https://s3.amazonaws.com"
            }
        }
    },

    "Conditions": {
        "InfaOnWindows": {
            "Fn::Equals": [
                {
                    "Ref": "AMIOS"
                },
                "Windows"
            ]
        },
        "InfaOnCentos": {
            "Fn::Equals": [
                {
                    "Ref": "AMIOS"
                },
                "CentOS-7-HVM"
            ]
        }
    },

    "Resources" : {
        "WorkloadStack": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": {
                    "Fn::Join": [
                        "/",
                        [
                            {
                                "Fn::FindInMap": [
                                    "DefaultConfiguration",
                                    "QSS3Config",
                                    "QuickStartS3URL"
                                ]
                            },
                            {
                                "Fn::FindInMap": [
                                    "DefaultConfiguration",
                                    "QSS3Config",
                                    "QSS3BucketName"
                                ]
                            },
                            {
                                "Fn::FindInMap": [
                                    "DefaultConfiguration",
                                    "QSS3Config",
                                    "QSS3KeyPrefix"
                                ]
                            },
                            {
                                "Fn::If": [
                                    "InfaOnWindows",
                                    "tableau-single-server.template",
                                    {
                                        "Fn::If": [
                                            "InfaOnCentos",
                                            "tableau_server_standalone_centos.json",
                                            "tableau_server_standalone_ubuntu.json"]
                                    }
                                ]
                            }
                        ]
                    ]
                },
                "Parameters": {
                    "InstanceType" : {
                        "Ref": "InstanceType"
                    },
                    "TableauServerVolumeSize" : {
                        "Ref": "TableauServerVolumeSize"
                    },
                    "KeyPairName": {
                        "Ref": "KeyPairName"
                    },
                    "SourceCIDR": {
                        "Ref": "SourceCIDR"
                    },
                    "Username" : {
                        "Fn::If": [
                            "InfaOnWindows",
                            {
                                "Ref": "AWS::NoValue"
                            },
                            {
                                "Ref": "Username"
                            }
                        ]
                    },
                    "Password" : {
                        "Fn::If": [
                            "InfaOnWindows",
                            {
                                "Ref": "AWS::NoValue"
                            },
                            {
                                "Ref": "Password"
                            }
                        ]
                    },
                    "TableauServerAdminUser" : {
                        "Ref": "TableauServerAdminUser"
                    },
                    "TableauServerAdminPassword" : {
                        "Ref": "TableauServerAdminPassword"
                    },
                    "TableauServerLicenseKey" : {
                        "Ref": "TableauServerLicenseKey"
                    },
                    "RegFirstName" : {
                        "Ref": "RegFirstName"
                    },
                    "RegLastName" : {
                        "Ref": "RegLastName"
                    },
                    "RegEmail" : {
                        "Ref": "RegEmail"
                    },
                    "RegCompany" : {
                        "Ref": "RegCompany"
                    },
                    "RegTitle" : {
                        "Ref": "RegTitle"
                    },
                    "RegDepartment" : {
                        "Ref": "RegDepartment"
                    },
                    "RegIndustry" : {
                        "Ref": "RegIndustry"
                    },
                    "RegPhone" : {
                        "Ref": "RegPhone"
                    },
                    "RegCity" : {
                        "Ref": "RegCity"
                    },
                    "RegState" : {
                        "Ref": "RegState"
                    },
                    "RegZip" : {
                        "Ref": "RegZip"
                    },
                    "RegCountry" : {
                        "Ref": "RegCountry"
                    },
                    "ExistingSecurityGroup" : {
                        "Ref": "ExistingSecurityGroup"
                    },
                    "IPAddress" : {
                        "Ref": "IPAddress"
                    }
                }
            }
        }
    },

    "Outputs" : {
        "InstanceID": {
            "Description": "EC2 InstanceID of the instance running Tableau Server",
            "Value": {
                "Fn::GetAtt": [
                    "WorkloadStack",
                    "Outputs.InstanceID"
                ]
            }
        },
        "PublicIPAddress": {
            "Description": "Public IP Address of instance running Tableau Server",
            "Value": {
                "Fn::GetAtt": [
                    "WorkloadStack",
                    "Outputs.PublicIPAddress"
                ]
            }
        },
        "TableauServerURL" : {
            "Description" : "URL for the Tableau Server",
            "Value" : {
                "Fn::GetAtt": [
                    "WorkloadStack",
                    "Outputs.TableauServerURL"
                ]
            }
        }
    }
}
